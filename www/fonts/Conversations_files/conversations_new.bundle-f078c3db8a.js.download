canvasWebpackJsonp([396],{1312:function(e,t,s){var i=function(e,t){return function(){return e.apply(t,arguments)}},o={}.hasOwnProperty,n=function(e,t){function s(){this.constructor=e}for(var i in t)o.call(t,i)&&(e[i]=t[i]);return s.prototype=t.prototype,e.prototype=new s,e.__super__=t.prototype,e};s.e(34).then(function(){var e=[s(535),s(0),s(4),s(11),s(638),s(849),s(725),s(944),s(942),s(943),s(945),s(941),s(102),s(661),s(848),s(513),s(837),s(31)];(function(e,t,s,o,r,a,l,h,c,d,u,p,m,g,y,f){var _,v;return _=function(o){function r(){return this.onKeyDown=i(this.onKeyDown,this),this.onSearch=i(this.onSearch,this),this.onNewConversations=i(this.onNewConversations,this),this.onSubmissionAddMessage=i(this.onSubmissionAddMessage,this),this.onAddMessage=i(this.onAddMessage,this),this.onSubmit=i(this.onSubmit,this),this._replyFromRemote=i(this._replyFromRemote,this),this.onCourse=i(this.onCourse,this),this.onFilter=i(this.onFilter,this),this.onStarToggle=i(this.onStarToggle,this),this.onForward=i(this.onForward,this),this.onMarkRead=i(this.onMarkRead,this),this.onMarkUnread=i(this.onMarkUnread,this),this.onCompose=i(this.onCompose,this),this.onDelete=i(this.onDelete,this),this.onArchive=i(this.onArchive,this),this.onReplyAll=i(this.onReplyAll,this),this.onReply=i(this.onReply,this),this.onSubmissionReply=i(this.onSubmissionReply,this),this.selectConversation=i(this.selectConversation,this),this.onSelected=i(this.onSelected,this),v=r.__super__.constructor.apply(this,arguments)}return n(r,o),r.prototype.routes={"":"index","filter=:state":"filter"},r.prototype.messages={confirmDelete:e.t("confirm.delete_conversation","Are you sure you want to delete your copy of this conversation? This action cannot be undone."),messageDeleted:e.t("message_deleted","Message Deleted!")},r.prototype.sendingCount=0,r.prototype.initialize=function(){var e;if(e=this._initCollections(),this._initViews(),this._attachEvents(),this._isRemoteLaunch())return e.then(this._replyFromRemote)},r.prototype.param=function(e){var t,s;return t=new RegExp(""+e+"=([^&]+)"),s=window.location.search.match(t),s?decodeURIComponent(s[1]):null},r.prototype.batchUpdate=function(e,i){var o,n=this;return null==i&&(i=t.noop),o=s.map(this.list.selectedMessages,function(e){return i.call(n,e),e.get("id")}),t.ajaxJSON("/api/v1/conversations","PUT",{"conversation_ids[]":o,event:e}),"destroy"===e&&(this.list.selectedMessages=[]),"archive"===e&&"sent"!==this.filters.type&&(this.list.selectedMessages=[]),"mark_as_read"===e&&"archived"===this.filters.type&&(this.list.selectedMessages=[]),"unstar"===e&&"starred"===this.filters.type&&(this.list.selectedMessages=[]),o},r.prototype.lastFetch=null,r.prototype.onSelected=function(e){var t;return this.lastFetch&&this.lastFetch.abort(),this.header.onModelChange(null,this.model),this.detail.onModelChange(null,this.model),this.model=e,t=this.list.selectedMessages,0===t.length?(delete this.detail.model,this.detail.render()):t.length>1?(delete this.detail.model,t[0].set("canArchive","sent"!==this.filters.type),this.detail.onModelChange(t[0],null),this.detail.render({batch:!0}),this.header.onModelChange(t[0],null),this.header.toggleReplyBtn(!0),this.header.toggleReplyAllBtn(!0),this.header.hideForwardBtn(!0),void 0):(e=this.list.selectedMessage(),e.get("messages")?this.selectConversation(e):(this.lastFetch=e.fetch({data:{include_participant_contexts:!1,include_private_conversation_enrollments:!1},success:this.selectConversation}),this.detail.$el.disableWhileLoading(this.lastFetch)))},r.prototype.selectConversation=function(e){return e&&e.set("canArchive","sent"!==this.filters.type),this.header.onModelChange(e,null),this.detail.onModelChange(e,null),this.detail.render()},r.prototype.onSubmissionReply=function(){return this.submissionReply.show(this.detail.model,{trigger:t("#submission-reply-btn")})},r.prototype.onReply=function(e){return this.detail.model.get("for_submission")?this.onSubmissionReply():this._delegateReply(e,"reply")},r.prototype.onReplyAll=function(e){return this._delegateReply(e,"replyAll")},r.prototype._delegateReply=function(e,s){var i,o;return i="reply"===s?"reply-btn":"reply-all-btn",o=t(e?".message-item-view[data-id="+e.id+"] ."+i:"#"+i),this.compose.show(this.detail.model,{to:s,trigger:o,message:e})},r.prototype.onArchive=function(){var e,t;if(e="archived"===this.list.selectedMessage().get("workflow_state")?"mark_as_read":"archive",t=this.batchUpdate(e,function(t){var s;return s="mark_as_read"===e?"read":"archived",t.set("workflow_state",s),this.header.onArchivedStateChange(t)}),s.include(["inbox","archived"],this.filters.type))return this.list.collection.remove(t),this.selectConversation(null)},r.prototype.onDelete=function(){var e;if(confirm(this.messages.confirmDelete))return e=this.batchUpdate("destroy"),delete this.detail.model,this.list.collection.remove(e),this.header.updateUi(null),t.flashMessage(this.messages.messageDeleted),this.detail.render()},r.prototype.onCompose=function(e){return this.compose.show(null,{trigger:t("#compose-btn")})},r.prototype.index=function(){return this.filter("")},r.prototype.filter=function(e){var t;return t=this.filters=m(e),this.header.displayState(t),this.selectConversation(null),this.list.selectedMessages=[],this.list.collection.reset(),"submission_comments"===t.type?(s.each(["scope","filter","filter_mode","include_private_conversation_enrollments"],this.list.collection.deleteParam,this.list.collection),this.list.collection.url="/api/v1/users/self/activity_stream",this.list.collection.setParam("asset_type","Submission"),t.course?this.list.collection.setParam("context_code",t.course):this.list.collection.deleteParam("context_code")):(s.each(["context_code","asset_type","submission_user_id"],this.list.collection.deleteParam,this.list.collection),this.list.collection.url="/api/v1/conversations",this.list.collection.setParam("scope",t.type),this.list.collection.setParam("filter",this._currentFilter()),this.list.collection.setParam("filter_mode","and"),this.list.collection.setParam("include_private_conversation_enrollments",!1)),this.list.collection.fetch(),this.compose.setDefaultCourse(t.course)},r.prototype.onMarkUnread=function(){return this.batchUpdate("mark_as_unread",function(e){return e.toggleReadState(!1)})},r.prototype.onMarkRead=function(){return this.batchUpdate("mark_as_read",function(e){return e.toggleReadState(!0)})},r.prototype.onForward=function(e){var i,o;return i=e?(i=this.detail.model.clone(),i.handleMessages(),i.set("messages",s.filter(i.get("messages"),function(t){return t.id===e.id||s.include(t.participating_user_ids,e.author_id)&&t.created_at<e.created_at})),o=t(".message-item-view[data-id="+e.id+"] .al-trigger"),i):(o=t("#admin-btn"),this.detail.model),this.compose.show(i,{to:"forward",trigger:o})},r.prototype.onStarToggle=function(){var e,t;if(e=this.list.selectedMessage().get("starred")?"unstar":"star",t=this.batchUpdate(e,function(t){return t.toggleStarred("star"===e)}),"starred"===this.filters.type)return"unstar"===e&&this.selectConversation(null),this.list.collection.remove(t)},r.prototype.onFilter=function(e){var s;return s=window.location.hash&&window.location.hash.substring(1),this.navigate("filter="+t.param(e),{trigger:!0,replace:!s})},r.prototype.onCourse=function(e){return this.list.updateCourse(e)},r.prototype._isRemoteLaunch=function(){return!!window.location.search.match(/user_id/)},r.prototype._replyFromRemote=function(){return this.compose.show(null,{user:{id:this.param("user_id"),name:this.param("user_name")},context:this.param("context_id"),remoteLaunch:!0})},r.prototype._initCollections=function(){var e;return e=new f,e.setParam("include[]","can_message"),this.courses={favorites:new y,all:new g,groups:e},this.courses.favorites.fetch()},r.prototype._initViews=function(){return this._initListView(),this._initDetailView(),this._initHeaderView(),this._initComposeDialog(),this._initSubmissionCommentReplyDialog()},r.prototype._attachEvents=function(){return this.list.collection.on("change:selected",this.onSelected),this.header.on("compose",this.onCompose),this.header.on("reply",this.onReply),this.header.on("reply-all",this.onReplyAll),this.header.on("archive",this.onArchive),this.header.on("delete",this.onDelete),this.header.on("filter",this.onFilter),this.header.on("course",this.onCourse),this.header.on("mark-unread",this.onMarkUnread),this.header.on("mark-read",this.onMarkRead),this.header.on("forward",this.onForward),this.header.on("star-toggle",this.onStarToggle),this.header.on("search",this.onSearch),this.header.on("submission-reply",this.onReply),this.compose.on("close",this.onCloseCompose),this.compose.on("addMessage",this.onAddMessage),this.compose.on("addMessage",this.list.updateMessage),this.compose.on("newConversations",this.onNewConversations),this.compose.on("submitting",this.onSubmit),this.submissionReply.on("addMessage",this.onSubmissionAddMessage),this.submissionReply.on("submitting",this.onSubmit),this.detail.on("reply",this.onReply),this.detail.on("reply-all",this.onReplyAll),this.detail.on("forward",this.onForward),this.detail.on("star-toggle",this.onStarToggle),this.detail.on("delete",this.onDelete),this.detail.on("archive",this.onArchive),t(document).ready(this.onPageLoad),t(window).keydown(this.onKeyDown)},r.prototype.onPageLoad=function(e){return t("#main").css({display:"block"})},r.prototype.onSubmit=function(e){var t=this;return this._incrementSending(1),e.always(function(){return t._incrementSending(-1)})},r.prototype.onAddMessage=function(e,t){var s;if(s=this.list.collection.get(t.id),null!=s&&s.get("messages")&&(e.context_name=s.messageCollection.last().get("context_name"),s.get("messages").unshift(e),s.trigger("change:messages"),s===this.detail.model))return this.detail.render()},r.prototype.onSubmissionAddMessage=function(e,t){var s;if(s=this.list.collection.findWhere({submission_id:t.id}),null!=s&&s.get("messages")&&(s.get("messages").unshift(e),s.trigger("change:messages"),s===this.detail.model))return this.detail.render()},r.prototype.onNewConversations=function(e){},r.prototype._incrementSending=function(e){return this.sendingCount+=e,this.header.toggleSending(this.sendingCount>0)},r.prototype._currentFilter=function(){var e;return e=this.searchTokens||[],this.filters.course&&(e=e.concat(this.filters.course)),e},r.prototype.onSearch=function(e){var t;return this.list.collection.reset(),this.searchTokens=e.length?e:null,"submission_comments"===this.filters.type?this.searchTokens&&(t=this.searchTokens[0].match(/^user_(\d+)$/))?this.list.collection.setParam("submission_user_id",t[1]):this.list.collection.deleteParam("submission_user_id"):this.list.collection.setParam("filter",this._currentFilter()),delete this.detail.model,this.list.selectedMessages=[],this.detail.render(),this.list.collection.fetch()},r.prototype._initListView=function(){return this.list=new h({collection:new a,el:t(".message-list"),scrollContainer:t(".message-list-scroller"),buffer:50}),this.list.render()},r.prototype._initDetailView=function(){return this.detail=new c({el:t(".message-detail")}),this.detail.render()},r.prototype._initHeaderView=function(){return this.header=new p({el:t("header.panel"),courses:this.courses}),this.header.render()},r.prototype._initComposeDialog=function(){return this.compose=new d({courses:this.courses,folderId:ENV.CONVERSATIONS.ATTACHMENTS_FOLDER_ID,account_context_code:ENV.CONVERSATIONS.ACCOUNT_CONTEXT_CODE})},r.prototype._initSubmissionCommentReplyDialog=function(){return this.submissionReply=new u},r.prototype.onKeyDown=function(e){var t,s;s=e.target.nodeName.toLowerCase(),"input"!==s&&"textarea"!==s&&(t=e.ctrlKey||e.metaKey,65===e.which&&t&&(e.preventDefault(),this.list.selectAll()))},r}(o.Router),window.conversationsRouter=new _,o.history.start()}).apply(null,e)}).catch(s.oe)}},[1312]);